<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Jandex Maven Plugin with Shading :: Jandex documentation</title>
    <link rel="prev" href="advanced.html">
    <meta name="generator" content="Antora 3.0.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <button class="nav-toggle"></button>

      <a class="navbar-item title" href="../index.html">Jandex</a>

      <div class="navbar-item has-dropdown is-hoverable">
        <span class="navbar-link">3.0.0</span>
        <div class="navbar-dropdown navbar-menu">
            <a class="navbar-item " href="../../3.1.1/index.html">3.1.1</a>
            <a class="navbar-item " href="../../3.1.0/index.html">3.1.0</a>
            <a class="navbar-item " href="../../3.0.5/index.html">3.0.5</a>
            <a class="navbar-item " href="../../3.0.4/index.html">3.0.4</a>
            <a class="navbar-item " href="../../3.0.3/index.html">3.0.3</a>
            <a class="navbar-item " href="../../3.0.2/index.html">3.0.2</a>
            <a class="navbar-item " href="../../3.0.1/index.html">3.0.1</a>
            <a class="navbar-item  is-current" href="../index.html">3.0.0</a>
        </div>
      </div>


      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <a class="navbar-item" href="https://smallrye.io/">SmallRye.io main website</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jandex" data-version="3.0.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list nav-list-level-0">
  <li class="nav-item nav-item-level-0">
<ul class="nav-list nav-list-level-1">
  <li class="nav-item nav-item-level-1">
    <a class="nav-link" href="../index.html">Introduction</a>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Jandex</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../core/getting.html">Getting Jandex</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../core/browsing.html">Browsing Declarations and Types</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="../core/indexing.html">Indexing Classes</a>
  </li>
</ul>
  </li>
  <li class="nav-item nav-item-level-1">
    <span class="nav-text">Jandex Maven Plugin</span>
<ul class="nav-list nav-list-level-2">
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="basic.html">Basic Usage</a>
  </li>
  <li class="nav-item nav-item-level-2">
    <a class="nav-link" href="advanced.html">Advanced Usage</a>
  </li>
  <li class="nav-item nav-item-level-2 is-current-page">
    <a class="nav-link" href="shading.html">Usage with Shading</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="content">
<aside class="toc sidebar" data-title="Table of contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
  <a href="https://github.com/smallrye/jandex/blob/3.0.0/doc/modules/ROOT/pages/maven/shading.adoc" class="edit-this-page" title="Edit this page">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>
<h1 class="page">Using Jandex Maven Plugin with Shading</h1>
<div class="paragraph">
<p>The Jandex Maven plugin has an additional goal <code>jandex-jar</code> that can be used to create an index inside an existing JAR.
This goal is not bound to any phase by default, so you have to configure that manually.</p>
</div>
<div class="paragraph">
<p>It is useful together with shading, where the Maven Shade plugin creates a JAR from multiple previously existing JARs.
A shaded JAR may already contain a Jandex index, if at least one of the constituent JARs contains one, but that index is most likely <em>not</em> what you want.
First, it is an unmodified index originating in one of the constituent JARs.
If multiple constituent JARs contain an index, only one of them makes it to the shaded JAR; the others are lost.
Second, during shading, classes may be relocated, so the index data may become stale.</p>
</div>
<div class="paragraph">
<p>There is no support for merging existing index files from the original JARs.
Likewise, there is no support for applying class relocations over an existing index.</p>
</div>
<div class="paragraph">
<p>In short, if you want a shaded JAR to have a Jandex index, you have to reindex it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;io.smallrye&lt;/groupId&gt;
    &lt;artifactId&gt;jandex-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;${version.jandex}&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;id&gt;uberjar-index&lt;/id&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;
                &lt;goal&gt;jandex-jar&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
                &lt;jar&gt;${project.build.directory}/${project.build.finalName}.jar&lt;/jar&gt;
                &lt;includes&gt;
                    &lt;include&gt;com/example/my/project/**/*.class&lt;/include&gt;
                &lt;/includes&gt;
                &lt;excludes&gt;
                    &lt;exclude&gt;com/example/**/_private/*.class&lt;/exclude&gt;
                &lt;/excludes&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we want to reindex a shaded JAR, we have to make sure that the <code>jandex-jar</code> goal of the Jandex Maven plugin executes <em>later</em> than the <code>shade</code> goal of the Maven Shade plugin.
In this example, we bind the <code>jandex-jar</code> goal to the <code>package</code> phase, which is also the phase in which the <code>shade</code> goal of the Maven Shade plugin executes by default.
In such case, we have to put the <code>&lt;plugin&gt;</code> element of the Jandex Maven plugin <em>after</em> the <code>&lt;plugin&gt;</code> element of the Maven Shade plugin.</p>
</div>
<div class="paragraph">
<p>Remember that if the Jandex Maven plugin operates on a JAR that was produced by the Maven Shade plugin, and if the Maven Shade plugin is configured to perform class relocations, the Jandex Maven plugin operates on already relocated classes.
This is important for configuring includes and excludes correctly.</p>
</div>
<nav class="pagination">
  <span class="prev"><a href="advanced.html">Advanced Usage</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" src="../../../_/img/redhat.svg" alt="Red Hat"></a>
  </p>
  <p>
    Made with <a href="https://github.com/smallrye/smallrye-antora-ui">SmallRye Antora UI</a>, which is licensed under the MPL-2.0 license.
    Includes portions of <a href="https://squidfunk.github.io/mkdocs-material/">Material for MkDocs</a>, which is licensed under the MIT license.
  </p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
